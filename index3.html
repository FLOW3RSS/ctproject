<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¹„ë²„ì±Œë¦°ì§€: AI ìš°ì‚° ì˜ˆì¸¡ê¸°</title>
  <style>
    body { font-family: 'Arial'; background: #f2f9ff; padding: 20px; line-height: 1.6; }
    h1, h2 { color: #003366; }
    .section { margin-bottom: 18px; }
    .problem-box { border: 2px solid #3399cc; background: #e0f7ff; padding: 16px; margin-bottom: 20px;}
    label { font-weight: bold; }
    .btn { padding: 8px 16px; background: #007acc; color: white; border: none; cursor: pointer; margin: 6px 0 0 0; border-radius: 6px; }
    .btn:disabled { background: #999; cursor: not-allowed;}
    .result { margin-top: 12px; padding: 10px; font-weight: bold; border-radius: 8px; }
    .í•„ìˆ˜ { background: #ffcdd2; color: #b71c1c; }
    .ê¶Œì¥ { background: #fff9c4; color: #827717; }
    .ì„ íƒ { background: #c8e6c9; color: #1b5e20; }
    #map { height: 270px; margin-bottom: 16px; }
    .chart-switch { margin-bottom: 7px; }
    .chart-switch button { padding: 7px 20px; border-radius: 7px; margin-right: 7px; border: none; background: #e3e7f7; color: #234; font-weight: bold; cursor: pointer;}
    .chart-switch .selected { background: #1976d2; color: white;}
    canvas { margin-top: 7px; background: white; border: 1px solid #ccc; }
    .qbox { margin-top: 28px; border: 2px solid #8eb2ff; background: #eef4fd; border-radius: 10px; padding: 17px;}
    .qtitle { font-weight:bold; color: #0c2461; font-size: 20px; margin-bottom: 12px;}
    .qdesc { color:#3e4b77; margin-bottom: 9px; font-size:16px;}
    .qrule { background: #f7faff; border-left: 4px solid #1976d2; padding: 7px 12px; margin: 8px 0 15px 0; font-size:15px;}
    .choices button { margin: 7px; padding: 9px 23px; font-weight: bold; border-radius: 7px;}
    .ansMsg { margin-top: 10px; font-weight: bold;}
    .progress-container { height: 11px; background: #eee; margin-top: 13px; border-radius: 7px; overflow: hidden;}
    .progress-bar { height: 11px; background: #1976d2; width: 100%; transition: width 1s linear;}
    .timer-row { font-size: 17px; color: #30306a; font-weight:bold; margin: 11px 0 8px 0;}
    select { font-size: 17px; margin-left: 9px; padding: 3px 14px; border-radius: 7px; border: 1.5px solid #aaa;}
    .choice-tbl { border-collapse: collapse; width: 380px; margin: 13px 0 7px 0;}
    .choice-tbl th, .choice-tbl td { border: 1px solid #ccc; padding: 4px 10px; text-align:center; }
    .choice-tbl th { background: #c8d9fc; }
    .not-started { opacity: 0.3; pointer-events: none;}
    .started { opacity: 1; pointer-events: auto;}
    .popup { display: none; position: fixed; top: 36%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid #3399cc; border-radius:14px; padding: 34px 45px; z-index: 999; text-align: center; font-size: 19px;}
    .popup button { margin-top: 18px; padding: 10px 26px; border-radius: 7px; font-size: 17px;}
    .explain { margin: 9px 0 0 0; color: #2941a5; font-size: 16px; }
    .mae-exp { color: #1976d2; font-size:15px; margin: 10px 0 0 0;}
    .warn { color:#b71c1c; background: #fff3e0; border-radius:7px; margin:9px 0 0 0; padding:6px 12px; display:inline-block;}
    .sol { background:#e9f5ff; border-radius: 7px; color:#0d47a1; padding:12px 14px; margin:12px 0 7px 0; font-size:15px;}
    .done-box { text-align:center; margin:55px 0 44px 0; padding:33px 8px 24px 8px; background:#e3f4fa; border-radius:18px; border:2px solid #2980b9; color:#17406a; font-size:23px;}
    .hide { display:none !important;}
    .show { display:block !important;}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h1>ğŸ¦« ë¹„ë²„ì±Œë¦°ì§€: AI ìš°ì‚° ì˜ˆì¸¡ê¸°</h1>
  <h2>ëŒ€ìƒ ë° êµê³¼: ê³ 1 ìˆ˜í•™(í•¨ìˆ˜, ë°ì´í„° í•´ì„), ê³ 2 í†µê³„Â·CT(ë¬¸ì œë¶„í•´/ì¶”ìƒí™”)</h2>
  <div class="section">
    <strong>ì§€ë¬¸:</strong>
    <p>
      ì‚¬ìš©ìëŠ” <b>AI ìš°ì‚° ì˜ˆì¸¡ê¸°</b>ë¥¼ í†µí•´ ìœ„ì¹˜ì˜ ì˜¤ëŠ˜/5ì¼ ë‚ ì”¨ ë°ì´í„°ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.<br>
      <b>AIëŠ” í™•ë¥  P = wâ‚Ã—R + wâ‚‚Ã—H + wâ‚ƒÃ—W + wâ‚„Ã—T (ê°€ì¤‘ì¹˜Ã—ê° ë³€ìˆ˜ì˜ ê°’)ë¡œ ì˜ˆì¸¡</b>í•˜ì—¬, <b>P â‰¥ 70: í•„ìˆ˜, 50â‰¤P&lt;70: ê¶Œì¥, P&lt;50: ì„ íƒ</b>ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.<br>
      (ì—¬ê¸°ì„œ R=ê°•ìˆ˜í™•ë¥ , H=ìŠµë„, W=í’ì†, T=ê¸°ì˜¨, wâ‚~wâ‚„ëŠ” ê° ë³€ìˆ˜ì˜ ê°€ì¤‘ì¹˜)
    </p>
  </div>
  <div class="section">
    <strong>ê·œì¹™:</strong>
    <ul>
      <li>ìœ„ë„Â·ê²½ë„ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ í´ë¦­í•´ ìœ„ì¹˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ê°€ì¤‘ì¹˜(0~1)ë¥¼ ììœ ë¡­ê²Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì˜ˆì¸¡ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>AIê°€ ìš°ì‚° íœ´ëŒ€ í•„ìš”ì„±(í•„ìˆ˜/ê¶Œì¥/ì„ íƒ)</b>ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.</li>
      <li>5ì¼ ì˜ˆì¸¡ì€ AI ì˜ˆì¸¡ì¹˜ì™€ ì‹¤ì œ ê°•ìˆ˜í™•ë¥ ì„ ê·¸ë˜í”„ë¡œ ë¹„êµ, <b>ì •í™•ë„(MAE)</b>ë„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </div>
  <div class="problem-box">
    <div id="map"></div>
    <div>
      <label>ğŸ“Œ ìœ„ë„</label>
      <input type="number" id="lat" value="37.5665" step="0.0001" />
      <label>ğŸ“Œ ê²½ë„</label>
      <input type="number" id="lon" value="126.9780" step="0.0001" />
      <button class="btn" id="btnToday" onclick="showChartTab('today')">ğŸŒ¤ ì˜¤ëŠ˜ ì˜ˆì¸¡</button>
      <button class="btn" id="btnForecast" onclick="showChartTab('forecast')">ğŸ“† 5ì¼ ì˜ˆì¸¡</button>
    </div>
    <div style="margin-top: 14px">
      <h3>ğŸ§ª ê°€ì¤‘ì¹˜ ì„¤ì • (0~1, í•©ì´ 1)</h3>
      <label>ê°•ìˆ˜í™•ë¥ :</label><input type="number" id="w_rain" value="0.5" step="0.1" min="0" max="1" style="width:60px;">
      <label>ìŠµë„:</label><input type="number" id="w_humidity" value="0.2" step="0.1" min="0" max="1" style="width:60px;">
      <label>í’ì†:</label><input type="number" id="w_wind" value="0.2" step="0.1" min="0" max="1" style="width:60px;">
      <label>ê¸°ì˜¨:</label><input type="number" id="w_temp" value="0.1" step="0.1" min="0" max="1" style="width:60px;">
      <span id="weightWarn" class="warn" style="display:none"></span>
    </div>
    <div>
      <div id="weatherInfo"></div>
      <div id="result" class="result"></div>
    </div>
    <div class="chart-switch">
      <button id="todayTab" onclick="showChartTab('today')" class="selected">ì˜¤ëŠ˜ ì˜ˆì¸¡</button>
      <button id="forecastTab" onclick="showChartTab('forecast')">5ì¼ ì˜ˆì¸¡</button>
    </div>
    <canvas id="chart1" width="400" height="200" style="display:"></canvas>
    <canvas id="chart5" width="600" height="300" style="display:none"></canvas>
  </div>

  <!-- ========== ë¬¸ì œí’€ì´ ì„¤ì •/íƒ€ì´ë¨¸/íŒì—… ========== -->
  <div class="problem-box" id="settingBox">
    <label>âŒ› ë¬¸ì œ í’€ì´ ì‹œê°„ ì„ íƒ: </label>
    <select id="timeSel">
      <option value="30">30ì´ˆ</option>
      <option value="60" selected>1ë¶„</option>
      <option value="90">1ë¶„ 30ì´ˆ</option>
      <option value="120">2ë¶„</option>
    </select>
    <button class="btn" onclick="resetQ1();resetQ2();startQuiz()">ë¬¸ì œ í’€ê¸° ì‹œì‘</button>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <div class="timer-row" id="timerRow" style="display:none;">â± ë‚¨ì€ ì‹œê°„: <span id="timer">--</span></div>
  </div>

  <div class="qbox not-started" id="q1box">
    <div class="qtitle">ë¬¸ì œ 1. [ë¹„ë²„ì±Œë¦°ì§€] AI ìš°ì‚° ì˜ˆì¸¡ ê³µì‹ì˜ ë¶„ë¥˜ ê²°ê³¼ëŠ”?</div>
    <div class="qdesc">  
      <b>ì¹´í”¼ë°”ë¼</b>ëŠ” ë‚ ì”¨ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ ìš°ì‚°ì´ 'í•„ìˆ˜', 'ê¶Œì¥', 'ì„ íƒ'ì¸ì§€ ì˜ˆì¸¡í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì„ ì—°êµ¬í•©ë‹ˆë‹¤.<br>
      <span style="font-size:16px;">ì•„ë˜ ê°’ê³¼ ë³´ê¸° ì¤‘ì—ì„œ <b>P = wâ‚Ã—R + wâ‚‚Ã—H + wâ‚ƒÃ—W + wâ‚„Ã—T</b> ê³„ì‚° ê²°ê³¼ì— ë”°ë¼<br>
      'ìš°ì‚° í•„ìˆ˜'ì— í•´ë‹¹í•˜ëŠ” <b>ë‹¨ í•˜ë‚˜ì˜ ì¡°í•©</b>ì„ ê³¨ë¼ë³´ì„¸ìš”.</span>
    </div>
    <div class="qrule">
      <b>ê·œì¹™:</b><br>
      1. ì…ë ¥ê°’: <span id="q1-input"></span><br>
      2. í™•ë¥ ì‹: <b>P = wâ‚Ã—R + wâ‚‚Ã—H + wâ‚ƒÃ—W + wâ‚„Ã—T</b><br>
      3. ë¶„ë¥˜: P â‰¥ 70 â†’ ìš°ì‚° í•„ìˆ˜<br>
        â€ƒâ€ƒ 50 â‰¤ P &lt; 70 â†’ ìš°ì‚° ê¶Œì¥<br>
        â€ƒâ€ƒ P &lt; 50 â†’ ìš°ì‚° ì„ íƒ
    </div>
    <table class="choice-tbl" id="q1-tbl"></table>
    <div class="choices" id="q1-choice"></div>
    <div class="ansMsg" id="ans1msg"></div>
    <div id="q1sol"></div>
  </div>

  <!-- ================== ê³„ì‚°í˜• 4ì§€ì„ ë‹¤ ë¬¸í•­2 =================== -->
  <div class="qbox not-started" id="q2box">
    <div class="qtitle">ë¬¸ì œ 2. [ë¹„ë²„ì±Œë¦°ì§€] ìš°ì‚° ì˜ˆì¸¡ ê³µì‹ì˜ ê°’(ì •ìˆ˜í•´) êµ¬í•˜ê¸°</div>
    <div class="qdesc" id="q2desc"></div>
    <div class="qrule" id="q2rule"></div>
    <div class="choices" id="q2-choice"></div>
    <div class="ansMsg" id="ans2msg"></div>
    <div id="q2sol"></div>
  </div>

  <div id="doneBox" class="done-box hide">
    <div>ğŸ‘ ëª¨ë“  ë¬¸ì œë¥¼ í’€ì´í•˜ì…¨ìŠµë‹ˆë‹¤!</div>
    <button class="btn" onclick="retryQuiz()">ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</button>
  </div>
  <script>
    // ===== ì§€ë„, ì°¨íŠ¸, ì˜ˆì¸¡ ë“± ê¸°ì¡´ ê¸°ëŠ¥ =====
    let myMap;
    window.onload = () => {
      myMap = L.map('map').setView([37.5665, 126.9780], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(myMap);
      let marker;
      myMap.on('click', function(e) {
        const { lat, lng } = e.latlng;
        document.getElementById('lat').value = lat.toFixed(4);
        document.getElementById('lon').value = lng.toFixed(4);
        if (marker) myMap.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(myMap);
      });
      weightInputs.forEach(input => input.addEventListener('input', weightCheck));
      weightCheck();
    };

    // ì˜¤ëŠ˜/5ì¼ ì˜ˆì¸¡ ê·¸ë˜í”„ íƒ­ ìŠ¤ìœ„ì¹˜
    function showChartTab(tab) {
      if(weightCheck()===false) return;
      document.getElementById('todayTab').classList.remove('selected');
      document.getElementById('forecastTab').classList.remove('selected');
      if(tab==='today') {
        document.getElementById('todayTab').classList.add('selected');
        document.getElementById('chart1').style.display = '';
        document.getElementById('chart5').style.display = 'none';
        fetchWeather();
      } else {
        document.getElementById('forecastTab').classList.add('selected');
        document.getElementById('chart1').style.display = 'none';
        document.getElementById('chart5').style.display = '';
        fetchForecast();
      }
    }

    // ê°€ì¤‘ì¹˜ ì…ë ¥ ì²´í¬
    const weightInputs = [
      document.getElementById('w_rain'),
      document.getElementById('w_humidity'),
      document.getElementById('w_wind'),
      document.getElementById('w_temp')
    ];
    function weightCheck() {
      let sum = 0;
      for(let i=0; i<weightInputs.length; i++) sum += parseFloat(weightInputs[i].value) || 0;
      if(sum > 1.00001) {
        document.getElementById('weightWarn').innerText = "ê°€ì¤‘ì¹˜ í•©ê³„ê°€ 1ì„ ë„˜ì—ˆìŠµë‹ˆë‹¤.";
        document.getElementById('weightWarn').style.display = '';
        document.getElementById('btnToday').disabled = true;
        document.getElementById('btnForecast').disabled = true;
        return false;
      } else {
        document.getElementById('weightWarn').innerText = "";
        document.getElementById('weightWarn').style.display = 'none';
        document.getElementById('btnToday').disabled = false;
        document.getElementById('btnForecast').disabled = false;
        return true;
      }
    }

    // ì˜¤ëŠ˜ ì˜ˆì¸¡
    async function fetchWeather() {
      if(!weightCheck()) return;
      const lat = document.getElementById("lat").value;
      const lon = document.getElementById("lon").value;
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&current_weather=true&hourly=precipitation_probability,relative_humidity_2m`;

      const res = await fetch(url);
      const data = await res.json();

      const temp = data.current_weather.temperature;
      const wind = data.current_weather.windspeed;
      const nowTime = data.current_weather.time;
      const idx = data.hourly.time.indexOf(nowTime);
      const humidity = data.hourly.relative_humidity_2m[idx] || 0;
      const rain = data.hourly.precipitation_probability[idx] || 0;

      document.getElementById("weatherInfo").innerText =
        `ğŸŒ¡ï¸ ê¸°ì˜¨: ${temp}â„ƒ | ğŸ’§ ìŠµë„: ${humidity}% | ğŸ’¨ í’ì†: ${wind}m/s | ğŸŒ§ï¸ ê°•ìˆ˜í™•ë¥ : ${rain}%`;

      predict(temp, humidity, wind, rain);
    }

    function predict(temp, humidity, wind, rain) {
      const wr = parseFloat(document.getElementById("w_rain").value);
      const wh = parseFloat(document.getElementById("w_humidity").value);
      const ww = parseFloat(document.getElementById("w_wind").value);
      const wt = parseFloat(document.getElementById("w_temp").value);

      const P = wr * rain + wh * humidity + ww * wind + wt * temp;
      let msg = "", level = "";
      if (P >= 70) { msg = `ìš°ì‚° í•„ìˆ˜! (ì˜ˆì¸¡ í™•ë¥ : ${P.toFixed(1)}%)`; level = "í•„ìˆ˜"; }
      else if (P >= 50) { msg = `ìš°ì‚° ê¶Œì¥! (ì˜ˆì¸¡ í™•ë¥ : ${P.toFixed(1)}%)`; level = "ê¶Œì¥"; }
      else { msg = `ìš°ì‚° ì„ íƒ ê°€ëŠ¥ (ì˜ˆì¸¡ í™•ë¥ : ${P.toFixed(1)}%)`; level = "ì„ íƒ"; }

      const result = document.getElementById("result");
      result.innerHTML = msg;
      result.className = `result ${level}`;

      drawChart1(P, rain);
    }

    function drawChart1(predict, actual) {
      const ctx = document.getElementById("chart1").getContext("2d");
      if (window.chart1 instanceof Chart) window.chart1.destroy();
      window.chart1 = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['AI ì˜ˆì¸¡ í™•ë¥ ', 'ì‹¤ì œ ê°•ìˆ˜í™•ë¥ '],
          datasets: [{
            label: '1ì¼ ì˜ˆì¸¡ ë¹„êµ',
            data: [Number(predict.toFixed(1)), Number(actual.toFixed(1))],
            backgroundColor: ['#2196f3', '#f44336']
          }]
        },
        options: {
          plugins: {
            title: { display: true, text: 'ğŸŒ‚ ì˜¤ëŠ˜ì˜ ì˜ˆì¸¡ vs ì‹¤ì œ' },
            datalabels: {
              anchor: 'end',
              align: 'end',
              formatter: (val) => val + '%',
              font: { weight: 'bold' }
            }
          },
          scales: { y: { beginAtZero: true, max: 100 } }
        },
        plugins: [ChartDataLabels]
      });
    }

    async function fetchForecast() {
      if(!weightCheck()) return;
      const lat = document.getElementById("lat").value;
      const lon = document.getElementById("lon").value;
      const today = new Date().toISOString().split('T')[0];
      const future = new Date(Date.now() + 4 * 86400000).toISOString().split('T')[0];
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&daily=temperature_2m_max,relative_humidity_2m_max,windspeed_10m_max,precipitation_probability_max` +
        `&timezone=auto&start_date=${today}&end_date=${future}`;
      const res = await fetch(url);
      const data = await res.json();
      const dates = data.daily.time;
      const T = data.daily.temperature_2m_max;
      const H = data.daily.relative_humidity_2m_max;
      const W = data.daily.windspeed_10m_max;
      const R = data.daily.precipitation_probability_max;

      const wr = parseFloat(document.getElementById("w_rain").value);
      const wh = parseFloat(document.getElementById("w_humidity").value);
      const ww = parseFloat(document.getElementById("w_wind").value);
      const wt = parseFloat(document.getElementById("w_temp").value);

      const predicted = dates.map((_, i) => wr * R[i] + wh * H[i] + ww * W[i] + wt * T[i]);

      drawChart5(dates, predicted, R);
      const box = document.getElementById("result");
      box.innerHTML = "";
      evaluateAccuracy(predicted, R);
    }

    function drawChart5(dates, predicted, actual) {
      const ctx = document.getElementById("chart5").getContext("2d");
      if (window.chart5 instanceof Chart) window.chart5.destroy();
      window.chart5 = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: "AI ì˜ˆì¸¡ í™•ë¥ ",
              data: predicted.map(x => Number(x.toFixed(1))),
              borderColor: "#007bff",
              fill: false
            },
            {
              label: "ì‹¤ì œ ê°•ìˆ˜í™•ë¥ ",
              data: actual.map(x => Number(x)),
              borderColor: "#dc3545",
              fill: false
            }
          ]
        },
        options: {
          plugins: {
            title: { display: true, text: "ğŸ“† 5ì¼ ì˜ˆì¸¡ vs ì‹¤ì œ ê°•ìˆ˜í™•ë¥ " },
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: (val) => val + '%',
              font: { weight: 'bold' }
            }
          },
          scales: {
            y: { beginAtZero: true, max: 100, ticks: { stepSize: 10 } }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // ì˜¤ì§ MAEë§Œ í‘œê¸° + ì„¤ëª…
    function evaluateAccuracy(predicted, actual) {
      const n = predicted.length;
      let sumAbsErr = 0;
      for (let i = 0; i < n; i++) {
        sumAbsErr += Math.abs(predicted[i] - actual[i]);
      }
      const mae = (sumAbsErr / n).toFixed(2);
      const box = document.getElementById("result");
      box.innerHTML += `<p class="mae-exp"><b>MAE</b>: ${mae}<br>
        <span>â€» MAE(í‰ê· ì ˆëŒ€ì˜¤ì°¨, Mean Absolute Error):<br>
        <b>ì‹¤ì œê°’ê³¼ ì˜ˆì¸¡ê°’ì˜ ì°¨ì´(|ì˜ˆì¸¡-ì‹¤ì œ|)ì˜ í‰ê· </b>ì„ ì˜ë¯¸.<br>
        ê°’ì´ 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì˜ˆì¸¡ ì •í™•ë„ê°€ ë†’ìŒì„ ì˜ë¯¸í•¨.<br>
        <b>ê³„ì‚°ì‹:</b> (|ì˜ˆì¸¡1-ì‹¤ì œ1| + |ì˜ˆì¸¡2-ì‹¤ì œ2| + ...)/ê°œìˆ˜</span></p>`;
    }

    // ================= ë¬¸ì œ1 ëœë¤ìƒì„±/í’€ì´ =================
    let q1 = {}, solved1=false, solved2=false;
    function resetQ1() {
      let ok = false, tryCnt=0, maxTry=50;
      let R,H,W,T,weights,P,correctIdx;
      while(!ok && tryCnt<maxTry) {
        R = Math.floor(Math.random() * 31) + 70;
        H = Math.floor(Math.random() * 21) + 70;
        W = Math.floor(Math.random() * 6) + 2;
        T = Math.floor(Math.random() * 6) + 25;
        let idx = Math.floor(Math.random()*4);
        let wSet = [
          [0.7,0.1,0.1,0.1],
          [0.3,0.3,0.2,0.2],
          [0.1,0.3,0.4,0.2],
          [0.1,0.1,0.4,0.4]
        ];
        weights = [];
        for(let i=0;i<4;i++) weights.push(wSet[(i+idx)%4]);
        P = [];
        for(let i=0;i<4;i++) {
          let w = weights[i];
          P.push(w[0]*R + w[1]*H + w[2]*W + w[3]*T);
        }
        let nFil = 0, ansIdx=-1;
        for(let i=0;i<4;i++) if(P[i]>=70) { nFil++; ansIdx=i; }
        if(nFil===1 && ansIdx!==-1) { correctIdx=ansIdx; ok=true; break; }
        tryCnt++;
      }
      if(!ok) {
        R=80;H=80;W=7;T=27;
        weights=[[0.7,0.1,0.1,0.1],[0.3,0.3,0.2,0.2],[0.1,0.3,0.4,0.2],[0.1,0.1,0.4,0.4]];
        P = [0.7*R+0.1*H+0.1*W+0.1*T,0.3*R+0.3*H+0.2*W+0.2*T,0.1*R+0.3*H+0.4*W+0.2*T,0.1*R+0.1*H+0.4*W+0.4*T];
        correctIdx=0;
      }
      q1.R=R; q1.H=H; q1.W=W; q1.T=T; q1.weights=weights; q1.P = P; q1.right = String.fromCharCode(65+correctIdx);
      let tblHTML = `<tr>
        <th>ë³´ê¸°</th><th>wâ‚(Rain)</th><th>wâ‚‚(Humidity)</th><th>wâ‚ƒ(Wind)</th><th>wâ‚„(Temp)</th>
      </tr>`;
      let choiceHTML = '';
      for(let i=0; i<4; i++) {
        let w = weights[i], label=String.fromCharCode(65+i);
        tblHTML += `<tr>
          <td>${label}</td><td>${w[0]}</td><td>${w[1]}</td><td>${w[2]}</td><td>${w[3]}</td>
        </tr>`;
        choiceHTML += `<button onclick="ans1('${label}')">${label}</button>`;
      }
      document.getElementById('q1-input').innerText = `R=${R}, H=${H}, W=${W}, T=${T}`;
      document.getElementById('q1-tbl').innerHTML = tblHTML;
      document.getElementById('q1-choice').innerHTML = choiceHTML;
      document.getElementById('ans1msg').innerHTML = '';
      document.getElementById('q1sol').innerHTML = '';
      solved1 = false;
      solved2 = false;
      document.getElementById('q1box').classList.remove('hide');
      document.getElementById('q2box').classList.remove('hide');
      document.getElementById('doneBox').classList.add('hide');
    }
    function ans1(sel) {
      if(solved1) return;
      let idx = sel.charCodeAt(0)-65;
      let w = q1.weights;
      let calcstr = w.map((v,i)=>{
        return `${String.fromCharCode(65+i)} : ${v[0]}Ã—${q1.R} + ${v[1]}Ã—${q1.H} + ${v[2]}Ã—${q1.W} + ${v[3]}Ã—${q1.T} = ${q1.P[i].toFixed(1)} â†’ ${q1.P[i]>=70?'í•„ìˆ˜':q1.P[i]>=50?'ê¶Œì¥':'ì„ íƒ'}`;
      }).join('<br>');
      let sol = `<div class="sol"><b>[í’€ì´ê³¼ì •]</b><br>
        1. ì…ë ¥ê°’ê³¼ ê° ë³´ê¸°ì˜ ê°€ì¤‘ì¹˜ë¥¼ í™•ë¥ ì‹ì— ëŒ€ì…<br>
        2. ê³„ì‚° ê²°ê³¼ Pê°€ 70 ì´ìƒì¸ ë³´ê¸°ë¥¼ ì°¾ìŒ<br>
        3. ì˜¤ì§ í•˜ë‚˜ì˜ ë³´ê¸°ë§Œ Pâ‰¥70(í•„ìˆ˜)ì´ë¯€ë¡œ í•´ë‹¹ ë³´ê¸°ê°€ ì •ë‹µ<br><br>${calcstr}<br>
        ì •ë‹µ: ${q1.right} (P=${q1.P[q1.right.charCodeAt(0)-65].toFixed(1)})</div>`;
      if(sel === q1.right) {
        document.getElementById("ans1msg").innerHTML = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
      } else {
        document.getElementById("ans1msg").innerHTML = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${q1.right})`;
      }
      document.getElementById('q1sol').innerHTML = sol;
      solved1=true;
      checkFinish();
    }

    // =============== ê³„ì‚°í˜•(ì •ìˆ˜í•´) 4ì§€ì„ ë‹¤ ë¬¸í•­2 ================
    let q2 = {};
    function resetQ2() {
      // ë³€ìˆ˜: w1~w4, H,W,TëŠ” ê³ ì •, 4ê°œ ë³´ê¸°
      let ok=false, tryCnt=0, ans=-1, w1,w2,w3,w4,H,W,T,Pmin,solR,choices=[];
      while(!ok && tryCnt<200) {
        w1 = (Math.random()*0.25+0.5).toFixed(2)*1;
        w2 = (Math.random()*0.25+0.1).toFixed(2)*1;
        w3 = (Math.random()*0.2+0.1).toFixed(2)*1;
        w4 = +(1.0-w1-w2-w3).toFixed(2);
        if(w4<0.05||w4>0.3) { tryCnt++; continue; }
        H = Math.floor(Math.random()*16)+75; // 75~90
        W = Math.floor(Math.random()*6)+3;   // 3~8
        T = Math.floor(Math.random()*6)+25;  // 25~30
        Pmin = w2*H + w3*W + w4*T;
        solR = Math.round((70-Pmin)/w1);
        if(solR<0 || solR>100 || Math.abs(w1*solR+Pmin-70)>0.95) { tryCnt++; continue; }
        // ë³´ê¸° ëœë¤ ìƒì„±, ì¤‘ë³µë°©ì§€, ì •ë‹µ ë³´ì¥
        let used = new Set([solR]);
        choices = [solR];
        while(choices.length<4) {
          let offset = Math.floor(Math.random()*9)+2; // 2~10
          let sign = Math.random()<0.5?-1:1;
          let v = solR + offset*sign;
          if(v<0||v>100||used.has(v)) continue;
          used.add(v);
          choices.push(v);
        }
        // ë³´ê¸° ì„ê¸°, ì •ë‹µ ì¸ë±ìŠ¤ êµ¬í•˜ê¸°
        for(let i=choices.length-1;i>0;i--){
          let j=Math.floor(Math.random()*(i+1));
          [choices[i],choices[j]]=[choices[j],choices[i]];
        }
        ans=choices.indexOf(solR);
        ok=true;
      }
      // ë Œë”ë§
      q2 = {w1,w2,w3,w4,H,W,T,Pmin,solR,choices,ans};
      document.getElementById('q2desc').innerHTML = `ìš°ì‚° ì˜ˆì¸¡ ê³µì‹ <b>P = wâ‚Ã—R + wâ‚‚Ã—H + wâ‚ƒÃ—W + wâ‚„Ã—T</b> (ë‹¨, 0â‰¤Râ‰¤100)ì—ì„œ<br>
        wâ‚=${w1}, wâ‚‚=${w2}, wâ‚ƒ=${w3}, wâ‚„=${w4}, H=${H}, W=${W}, T=${T}ì¼ ë•Œ,<br>
        <b>ìš°ì‚° í•„ìˆ˜(Pâ‰¥70)ê°€ ë˜ë ¤ë©´ ê°•ìˆ˜í™•ë¥  Rì´ ìµœì†Œ ëª‡ ì´ìƒì´ì–´ì•¼ í•˜ëŠ”ê°€?</b>`;
      document.getElementById('q2rule').innerHTML = `
        <b>ê·œì¹™:</b><br>
        1. ì‹ì— ëª¨ë“  ê°’ì„ ëŒ€ì…í•´ í’€ ê²ƒ<br>
        2. 70 = wâ‚R + wâ‚‚H + wâ‚ƒW + wâ‚„T ì´ë¯€ë¡œ, Rì„ ê³„ì‚°<br>
        3. ë³´ê¸° ì¤‘ ì˜¬ë°”ë¥¸ ì •ìˆ˜í•´ë¥¼ ê³ ë¥´ì„¸ìš”.
      `;
      let btns = "";
      for(let i=0;i<4;i++)
        btns += `<button onclick="ans2(${i})">${q2.choices[i]}</button>`;
      document.getElementById('q2-choice').innerHTML = btns;
      document.getElementById('ans2msg').innerHTML = "";
      document.getElementById('q2sol').innerHTML = "";
      solved2 = false;
    }
    function ans2(idx) {
      if(solved2) return;
      let exp = `â‘  ëª¨ë“  ìƒìˆ˜ ëŒ€ì…: 70 = (${q2.w1})R + (${q2.w2})Ã—${q2.H} + (${q2.w3})Ã—${q2.W} + (${q2.w4})Ã—${q2.T}
      <br>â‘¡ ${q2.w1}R = 70 - [${q2.w2}Ã—${q2.H} + ${q2.w3}Ã—${q2.W} + ${q2.w4}Ã—${q2.T}]
      <br>â‘¢ R = (70 - (${q2.w2*q2.H}+${q2.w3*q2.W}+${q2.w4*q2.T}).toFixed(2)) / ${q2.w1} â‰ˆ <b>${q2.solR}</b>
      <br>â‘£ ì •ë‹µ: <b>${q2.solR}</b> (ê°•ìˆ˜í™•ë¥  ìµœì†Œê°’)`;
      if(idx===q2.ans) {
        document.getElementById('ans2msg').innerHTML = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
      } else {
        document.getElementById('ans2msg').innerHTML = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${q2.solR})`;
      }
      document.getElementById('q2sol').innerHTML = `<div class="sol"><b>[í’€ì´ê³¼ì •]</b><br>${exp}</div>`;
      solved2 = true;
      checkFinish();
    }
    function checkFinish() {
      if(solved1 && solved2) {
        setTimeout(()=>{
          // box ìˆ¨ê¸°ì§€ ì•Šê³ , not-startedë§Œ í•´ì œí•´ë†“ê³ , "ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°" í™œì„±í™”
          document.getElementById('doneBox').classList.remove('hide');
          document.getElementById('q1box').classList.remove('started'); // í´ë¦­ ë¶ˆê°€
          document.getElementById('q2box').classList.remove('started'); // í´ë¦­ ë¶ˆê°€
          document.getElementById('q1box').classList.add('not-started');
          document.getElementById('q2box').classList.add('not-started');
        }, 500);
      }
    }
    // =================== íƒ€ì´ë¨¸/ì§„í–‰ ë“± ====================
    let time=0, remain=0, interval=null;
    function startQuiz(){
      document.getElementById('settingBox').style.pointerEvents='none';
      document.getElementById('settingBox').style.opacity='0.6';
      document.getElementById('q1box').classList.remove('not-started','hide');
      document.getElementById('q1box').classList.add('started');
      document.getElementById('q2box').classList.remove('not-started','hide');
      document.getElementById('q2box').classList.add('started');
      document.getElementById('timerRow').style.display='';
      time = Number(document.getElementById("timeSel").value);
      remain = time;
      document.getElementById("timer").innerText = remain;
      document.getElementById("progressBar").style.width = "100%";
      interval = setInterval(()=>{
        remain--;
        document.getElementById("timer").innerText = remain;
        document.getElementById("progressBar").style.width = (remain/time*100) + "%";
        if(remain<=0){
          clearInterval(interval);
          showTimeout();
        }
      }, 1000);
    }
    function showTimeout(){
      document.getElementById('popupMsg').innerHTML = "â° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ì•„ì‰½ì§€ë§Œ ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”.";
      document.getElementById('popup').style.display = 'block';
      document.getElementById('q1box').style.pointerEvents='none';
      document.getElementById('q2box').style.pointerEvents='none';
      document.getElementById('q1box').style.opacity='0.5';
      document.getElementById('q2box').style.opacity='0.5';
    }
    function retryQuiz(){
      location.reload();
    }
  </script>
</body>
</html>
